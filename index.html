<!DOCTYPE html>
<html lang="nl">
    <head>
        <title>Kraak de Code</title>
        
        <!-- meta settings -->
        <meta charset="utf-8">        
        <meta name="mobileoptimized" content="true">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#8cd5ff">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        
        <link rel="manifest" href="manifest.json">
        <link rel="icon" type="image/png" href="icons/icon-32.png">
        
        <!-- icons inclusion -->
        <link rel="shortcut icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
        <link rel="apple-touch-icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

        <style>
            @font-face {
                font-family: ComicNeue-Bold;
                src: url('fonts/ComicNeue-Bold.woff2') format('woff2'),
                     url('fonts/ComicNeue-Bold.woff') format('woff'),
                     url('fonts/ComicNeue-Bold.ttf') format('truetype');
                font-weight: bold;
                font-style: normal;
            }
            
            @font-face {
                font-family: OpenSans-Regular;
                src: url('fonts/OpenSans-Regular.woff2') format('woff2'),
                     url('fonts/OpenSans-Regular.woff') format('woff'),
                     url('fonts/OpenSans-Regular.ttf') format('truetype');
                font-weight: normal;
                font-style: normal;
            }
            
            @font-face {
                font-family: OpenSans-Bold;
                src: 
                     url('fonts/OpenSans-Bold.ttf') format('truetype');
                font-weight: bold;
                font-style: normal;
            }
            :root
            {
                --preview-width: min(90vw, 640px);
                --preview-height: calc(var(--preview-width) * 0.5);
            }
            
            html
            {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }
            
            body
            {
                margin: 0;
                padding: 0;
                background-color: grey;
                display: flex;
                flex-direction: row;
                width: 100%;
                height: 100%;
                color: #333;
                font-weight: 400;
                font-family: OpenSans-Regular;
            }
            
            #editor-panel
            {
                padding: 1rem;
                background-color: white;  
                display: flex;
                flex-direction: column;              
                overflow-y: auto;
                gap: 1rem;
            }
            
            label
            {
                font-size: 1rem;
            }
            
            .title-button
            {
                min-width: 7rem;
            }
            
            .inputs
            {
                display: grid;
                grid-template-columns: auto 1fr;
                grid-row-gap: 0.5rem;
                grid-column-gap: 0.5rem;
                align-items: center;
                margin-left: 0.5rem;
            }
        
            p 
            {
                margin: 0;
            }
            
            h1
            {
                margin: 0;
                font-size: 2.5rem;
                font-family: ComicNeue-Bold;
                text-transform: uppercase;
            }
            
            h2
            {
                font-size: 1.5rem;
                font-family: OpenSans-Bold;
                margin: 0;
                margin-bottom: 1rem;
            }
            
            input[type=text]
            {
            	box-sizing: border-box;
                border-radius: 2px;
                border: 1px solid black;
                height: 1.5rem;
                font-family: OpenSans-Regular;
            }
            
            input[type=text]:focus
            {
                outline-width: 0;
                border-radius: 4px;
                border: 2px solid blue;
            }
            
            input[type=checkbox]
            {
                margin-left: 0;
            }
            
            #exercises
            {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }
            
            #file-title-row
            {
                
            }
            
            .input-row, .upload-row, #file-title-row, #exercise-count-selection-row
            {
                display: flex;
                flex-direction: row;
                gap: 0.5rem;
                align-items: center;

            }
            
            #exercise-count-selection-row
            {
                align-items: center;
            }

            input[type=radio]
            {
                margin: 0;
            }

            #exercise-count-selection-row > input[type=radio]
            {
                margin-left: -0.25rem;
                margin-right: 0.25rem;
            }
            
            .input-column
            {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .spacer
            {
                flex: 1;
            }
        
            #preview-container
            {
                flex: 1;
                flex-direction: column;
                display: flex;
                align-content: center;
                align-items: center;
                justify-content: center;
                overflow: auto;
                padding: 1rem;
            }
            
            #preview
            {
                overflow: hidden;
                background-color: white;
                outline: 1px solid black;
            }
            
            button
            {
                font-family: OpenSans-Regular;
                min-height: 2rem;
                min-width: 6rem;
                border-radius: 4px;
                border: 0px;
                background-color: #3689e6;
                color: white;
                cursor: pointer;
                font-size: 1rem;
            }

            button[disabled]
            {
                background-color: gray;
            }
            
            .upload-button, .button
            {
                box-sizing: border-box;
                border-radius: 4px;
                text-align: center;
                background-color: #3689e6;
                color: white;
                font-size: 1rem;
                padding: 0.4rem 0.75rem;
                max-width: 10rem;
                cursor: pointer;
            }

            .bullet-button
            {
                min-width: 1.75rem;
                min-height: 1.75rem;
                width: 1.75rem;
                height: 1.75rem;
            }
            
            input[type=file]
            {
                font-family: OpenSans-Regular;
            }
            
            @media (max-aspect-ratio: 10/9)
            {
                h1
                {
                    text-align: center;
                }
                
                body 
                {
                    flex-direction: column;
                    height: 200%;
                }
                
                #title-buttons, #file-title-row, #exercise-count-selection-row
                {
                    justify-content: center;
                }
                
                #editor-panel
                {
                    flex: 1;
                    overflow-y: visible;
                }
                
                .upload-row
                {
                    flex-direction: column;
                }
                
                .upload-button
                {
                    align-self: stretch;
                    max-width: 100%;
                }
                
                #preview-container
                {
                    flex-direction: row;
                    min-height: 100vh;
                }
                
                .inputs
                {
                    margin-left: 0;
                }
                
                .exercise
                {
                    border: 1px solid #666;
                    padding: 1rem 2rem;
                    border-radius: 2px;
                }
                
            }
        </style>
       
        <script src="js/drawer.js"></script>
        <script src="js/ComicNeue-bold.js"></script>
    </head>
    
    <body>
        <div id = "editor-panel">
            <h1>Editor</h1>
            <div id = "title-buttons" class = "input-row">
                <button id = "save" class = "title-button" onclick = "saveFile()">Opslaan</button>
                <label class = "button title-button" for="load">Laden</label>
                <input id="load" type="file" accept="*" hidden>
                <button id = "saveToPDFButton" class = "title-button" onclick="savePdf()">PDF opslaan</button>
            </div>
            
            <div id = "file-title-row">
                <p>Bestandsnaam:</p>
                <input id="fileTitle" type="text" value="Kraak de Code">
            </div>
            <div id = "exercise-count-selection-row">
                <p>Aantal afbeeldingen:</p>
                <label for="exerciseCountRadio3">3</label>
                <input id="exerciseCountRadio3" name = "excerciseCount" type="radio" checked>
                <label for="exerciseCountRadio4">4</label>
                <input id="exerciseCountRadio4" name = "excerciseCount" type="radio">
            </div>
            
            <div id = "exercises">
                <div class = "exercise">
                    <h2>Oefening 1:</h2>

                    <div class = "inputs">
                        <p>Aanwezig:</p>
                        <input id = "exercise1CheckBox" input type="checkbox" checked>

                        <p>Titel:</p>
                        <input id="exercise1TitleInput" type="text" oninput="updateCanvas()" value="kraak de code">

                        <p>Afbeeldingen:</p>
                        <div class = "upload-row">
                            <label class = "upload-button" for="exercise1ImageInput1">Upload</label>
                            <input id="exercise1ImageInput1" type="file" accept="image/jpeg, image/png" hidden>
                            <label class = "upload-button" for="exercise1ImageInput2">Upload</label>
                            <input id="exercise1ImageInput2" type="file" accept="image/jpeg, image/png" hidden>
                            <label class = "upload-button" for="exercise1ImageInput3">Upload</label>
                            <input id="exercise1ImageInput3" type="file" accept="image/jpeg, image/png" hidden>
                            <label id="exercise1ImageInput4Label" class = "upload-button" for="exercise1ImageInput4">Upload</label>
                            <input id="exercise1ImageInput4" type="file" accept="image/jpeg, image/png" hidden>
                        </div>

                        <p>Bolletjes:</p>
                        <div class = "input-column">
                            <div class = "input-row">
                                <input id="exercise1Bullet1-1" name = "exercise1Bullet1" type="radio">
                                <input id="exercise1Bullet1-2" name = "exercise1Bullet1" type="radio" checked>
                                <input id="exercise1Bullet1-3" name = "exercise1Bullet1" type="radio">
                                <input id="exercise1Bullet1-4" name = "exercise1Bullet1" type="radio">
                                <div class = "spacer"></div>
                                <button id = "exercise1-bullet1-subtract" class = "bullet-button">-</button>
                                <button id = "exercise1-bullet1-add" class = "bullet-button">+</button>
                            </div>
                            <div class = "input-row">
                                <input id="exercise1Bullet2-1" name = "exercise1Bullet2" type="radio">
                                <input id="exercise1Bullet2-2" name = "exercise1Bullet2" type="radio" checked>
                                <input id="exercise1Bullet2-3" name = "exercise1Bullet2" type="radio">
                                <input id="exercise1Bullet2-4" name = "exercise1Bullet2" type="radio">
                                <div class = "spacer"></div>
                                <button id = "exercise1-bullet2-subtract" class = "bullet-button">-</button>
                                <button id = "exercise1-bullet2-add" class = "bullet-button">+</button>
                            </div>
                            <div class = "input-row">
                                <input id="exercise1Bullet3-1" name = "exercise1Bullet3" type="radio">
                                <input id="exercise1Bullet3-2" name = "exercise1Bullet3" type="radio" checked>
                                <input id="exercise1Bullet3-3" name = "exercise1Bullet3" type="radio">
                                <input id="exercise1Bullet3-4" name = "exercise1Bullet3" type="radio">
                                <div class = "spacer"></div>
                                <button id = "exercise1-bullet3-subtract" class = "bullet-button">-</button>
                                <button id = "exercise1-bullet3-add" class = "bullet-button">+</button>
                            </div>
                            <div id = "exercise1Bullet4Row" class = "input-row">
                                <input id="exercise1Bullet4-1" name = "exercise1Bullet4" type="radio">
                                <input id="exercise1Bullet4-2" name = "exercise1Bullet4" type="radio" checked>
                                <input id="exercise1Bullet4-3" name = "exercise1Bullet4" type="radio">
                                <input id="exercise1Bullet4-4" name = "exercise1Bullet4" type="radio">
                                <div class = "spacer"></div>
                                <button id = "exercise1-bullet4-subtract" class = "bullet-button">-</button>
                                <button id = "exercise1-bullet4-add" class = "bullet-button">+</button>
                            </div>
                        </div>

                        <p>Kleuren:</p>
                        <div class = "input-row">
                            <input id="exercise1BorderColor" type="color" value = "#000000">
                            <input id="exercise1BackgroundColor" type="color" value = "#ffffff">
                            <input id="exercise1AccentColor" type="color" value = "#8cd5ff">
                        </div>               
                    </div>
                </div>
                <div class= "exercise">
                    <h2>Oefening 2:</h2>

                    <div class = "inputs">
                        <p>Aanwezig:</p>
                        <input id = "exercise2CheckBox" input type="checkbox" checked>

                        <p>Titel:</p>
                        <input id="exercise2TitleInput" type="text" oninput="updateCanvas()" value="kraak de code">

                        <p>Afbeeldingen:</p>
                        <div class = "upload-row">
                            <label class = "upload-button" for="exercise2ImageInput1">Upload</label>
                            <input id="exercise2ImageInput1" type="file" accept="image/jpeg, image/png" hidden>
                            <label class = "upload-button" for="exercise2ImageInput2">Upload</label>
                            <input id="exercise2ImageInput2" type="file" accept="image/jpeg, image/png" hidden>
                            <label class = "upload-button" for="exercise2ImageInput3">Upload</label>
                            <input id="exercise2ImageInput3" type="file" accept="image/jpeg, image/png" hidden>
                            <label id = "exercise2ImageInput4Label" class = "upload-button" for="exercise2ImageInput4">Upload</label>
                            <input id="exercise2ImageInput4" type="file" accept="image/jpeg, image/png" hidden>
                        </div>

                        <p>Bolletjes:</p>
                        <div class = "input-column">
                            <div class = "input-row">
                                <input id="exercise2Bullet1-1" name = "exercise2Bullet1" type="radio">
                                <input id="exercise2Bullet1-2" name = "exercise2Bullet1" type="radio" checked>
                                <input id="exercise2Bullet1-3" name = "exercise2Bullet1" type="radio">
                                <input id="exercise2Bullet1-4" name = "exercise2Bullet1" type="radio">
                                <button id = "exercise2-bullet1-subtract" class = "bullet-button">-</button>
                                <button id = "exercise2-bullet1-add" class = "bullet-button">+</button>
                            </div>
                            <div class = "input-row">
                                <input id="exercise2Bullet2-1" name = "exercise2Bullet2" type="radio">
                                <input id="exercise2Bullet2-2" name = "exercise2Bullet2" type="radio" checked>
                                <input id="exercise2Bullet2-3" name = "exercise2Bullet2" type="radio">
                                <input id="exercise2Bullet2-4" name = "exercise2Bullet2" type="radio">
                                <button id = "exercise2-bullet2-subtract" class = "bullet-button">-</button>
                                <button id = "exercise2-bullet2-add" class = "bullet-button">+</button>
                            </div>
                            <div class = "input-row">
                                <input id="exercise2Bullet3-1" name = "exercise2Bullet3" type="radio">
                                <input id="exercise2Bullet3-2" name = "exercise2Bullet3" type="radio" checked>
                                <input id="exercise2Bullet3-3" name = "exercise2Bullet3" type="radio">
                                <input id="exercise2Bullet3-4" name = "exercise2Bullet3" type="radio">
                                <button id = "exercise2-bullet3-subtract" class = "bullet-button">-</button>
                                <button id = "exercise2-bullet3-add" class = "bullet-button">+</button>
                            </div>
                            <div id = "exercise2Bullet4Row" class = "input-row">
                                <input id="exercise2Bullet4-1" name = "exercise2Bullet4" type="radio">
                                <input id="exercise2Bullet4-2" name = "exercise2Bullet4" type="radio" checked>
                                <input id="exercise2Bullet4-3" name = "exercise2Bullet4" type="radio">
                                <input id="exercise2Bullet4-4" name = "exercise2Bullet4" type="radio">
                                <button id = "exercise2-bullet4-subtract" class = "bullet-button">-</button>
                                <button id = "exercise2-bullet4-add" class = "bullet-button">+</button>
                            </div>
                        </div>

                        <p>Kleuren:</p>
                        <div class = "input-row">
                            <input id="exercise2BorderColor" type="color" value = "#000000">
                            <input id="exercise2BackgroundColor" type="color" value = "#ffffff">
                            <input id="exercise2AccentColor" type="color" value = "#8cd5ff">
                        </div>               
                    </div>
                </div>
            </div>
        </div>
        <div id= "preview-container">
            <canvas id = "preview">
            </canvas>
        </div>


        <script>
            window.addEventListener('resize', updateCanvas);
            window.addEventListener('load', updateCanvas);
            
            const fileTitle = document.getElementById("fileTitle");
            const container = document.getElementById("preview-container");
            const canvas = document.getElementById("preview"); 
            const loadButton = document.getElementById("load");
            const saveToPDFButton = document.getElementById("saveToPDFButton");
            
            const exerciseCountRadio3 = document.getElementById("exerciseCountRadio3");
            const exerciseCountRadio4 = document.getElementById("exerciseCountRadio4");
            
            loadButton.oninput = (e) => { loadFile(e.target.files[0]); };
            
            /*****************************************************************/
            exerciseCountRadio3.onchange = () => { exerciseCountUpdated() };
            exerciseCountRadio4.onchange = () => { exerciseCountUpdated() };
            
            const exercise1Bullet4Row = document.getElementById("exercise1Bullet4Row");
            const exercise1Image4Label = document.getElementById("exercise1ImageInput4Label");
            const exercise2Bullet4Row = document.getElementById("exercise2Bullet4Row");
            const exercise2Image4Label = document.getElementById("exercise2ImageInput4Label");
            
            function exerciseCountUpdated()
            {
                const hide = getExerciseCount() === 3;
                exercise1Bullet4Row.style.display = hide ? "none" : "";
                exercise2Bullet4Row.style.display = hide ? "none" : "";
                exercise1Image4Label.style.display = hide ? "none" : "";
                exercise2Image4Label.style.display = hide ? "none" : "";
                updateCanvas();
            }
            
            function getExerciseCount()
            {
                return exerciseCountRadio4.checked ? 4 : 3;
            }
                        
            /*****************************************************************/
            
            const exercise1Images = createImages(1);
            const exercise2Images = createImages(2);
            const exerciseImages = [ exercise1Images, exercise2Images ];
            
            function createImages(exercise)
            {
                const imageArray = [];
                for(let i = 0; i < 4; i += 1)
                {
                    const image = new Image();
                    image.onload = () => { updateCanvas(); }
                    imageArray.push(image);
                }
                return imageArray;
            }
            
            function updateImageFunction(image)
            {
                return (e) => {
                    if (image.src)
                        URL.revokeObjectURL(image.src);
                    const url = URL.createObjectURL(e.target.files[0]);
                    image.src = url;
                }
            }

            /*****************************************************************/ 
            const exercise1BulletCounts = createBulletCounts(1);
            const exercise2BulletCounts = createBulletCounts(2);
            const exerciseBulletCounts = [ exercise1BulletCounts, exercise2BulletCounts ];
            
            function createBulletCounts()
            {
                return [ 3, 3, 3, 3 ];
            }
            
            function updateBulletsOf(exercise, row)
            {
                const count = exerciseBulletCounts[exercise - 1][row];
                for(let i = 0; i < count; ++i)
                    exerciseBullets[exercise - 1][row][i].style.visibility = '';
                for(let i = count; i < 4; ++i)
                    exerciseBullets[exercise - 1][row][i].style.visibility = "hidden";
            }

            function updateBulletsOfExercise(exercise)
            {
                for(let i = 0; i < 4; ++i)
                    updateBulletsOf(exercise, i);
            }

            function updateAllBullets()
            {
                updateBulletsOfExercise(1);
                updateBulletsOfExercise(2);
            }

            /*****************************************************************/
            const exercise1BulletCountAddElements = getBulletCountAddElements(1);
            const exercise2BulletCountAddElements = getBulletCountAddElements(2);
            const exerciseBulletCountAddElements = [ exercise1BulletCountAddElements, exercise2BulletCountAddElements ];

            const exercise1BulletCountSubtractElements = getBulletCountSubtractElements(1);
            const exercise2BulletCountSubtractElements = getBulletCountSubtractElements(2);
            const exerciseBulletCountSubtractElements = [ exercise1BulletCountSubtractElements, exercise2BulletCountSubtractElements ];


            function getBulletCountAddElements(exercise)
            {
                let result = [];
                for(let i = 1; i <= 4; ++i)
                    result.push(document.getElementById("exercise" + exercise + "-bullet" + i + "-add"));
                return result;
            }

            function getBulletCountSubtractElements(exercise)
            {
                let result = [];
                for(let i = 1; i <= 4; ++i)
                    result.push(document.getElementById("exercise" + exercise + "-bullet" + i + "-subtract"));
                return result;
            }

            function incrementBulletCount(exercise, row)
            {
                if (exerciseBulletCounts[exercise - 1][row] < 4)
                {
                    exerciseBulletCounts[exercise - 1][row] += 1;
                    updateBulletsOf(exercise, row);
                    updateBulletStates(exercise, row);
                    updateCanvas();
                }
            }

            function decrementBulletCount(exercise, row)
            {
                if (exerciseBulletCounts[exercise - 1][row] > 1)
                {
                    exerciseBulletCounts[exercise - 1][row] -= 1;
                    updateBulletsOf(exercise, row);
                    updateBulletStates(exercise, row);
                    updateCanvas();
                }
            }

            function updateBulletStates(exercise, row)
            {
                const count = exerciseBulletCounts[exercise - 1][row];
                exerciseBulletCountAddElements[exercise - 1][row].disabled = count === 4;
                exerciseBulletCountSubtractElements[exercise - 1][row].disabled = count === 1;
            }

            function updateAllBulletStates(exercise, row)
            {
                for(let i = 1; i <= 2; ++i)
                    for(let j = 0; j < 4; ++j)
                    updateBulletStates(i, j);
            }

            function connectToBulletCountAddAndSubtract()
            {
                for(let exercise = 1; exercise <= 2; ++exercise)
                {
                    for(let i = 0; i < 4; ++i)
                    {
                        exerciseBulletCountAddElements[exercise - 1][i].onclick = () => { incrementBulletCount(exercise, i)}
                        exerciseBulletCountSubtractElements[exercise - 1][i].onclick = () => { decrementBulletCount(exercise, i)}
                    }
                }
            }

            connectToBulletCountAddAndSubtract();

            /*****************************************************************/
            const exercise1Bullets = getExerciseBullets(1);
            const exercise2Bullets = getExerciseBullets(2);
            const exerciseBullets = [ exercise1Bullets, exercise2Bullets ];

            function getExerciseBullets(exercise)
            {
                let result = [];

                for(let i = 1; i <= 4; ++i)
                {
                    let bullets = [];
                    for(let j = 1; j <= 4; ++j)
                    {
                        bullets.push(document.getElementById("exercise" + exercise + "Bullet"+ i + "-" + j));
                    }
                    result.push(bullets);
                }
                
                return result;
            }

            function getExerciseElements(exercise)
            {
                return {
                    titleInput: document.getElementById("exercise" + exercise + "TitleInput"),
                    checkBox: document.getElementById("exercise" + exercise + "CheckBox"),
                    borderColor: document.getElementById("exercise" + exercise + "BorderColor"),
                    backgroundColor: document.getElementById("exercise" + exercise + "BackgroundColor"),
                    accentColor: document.getElementById("exercise" + exercise + "AccentColor"),
                    imageInputs: 
                    [
                        document.getElementById("exercise" + exercise + "ImageInput1"),
                        document.getElementById("exercise" + exercise + "ImageInput2"),
                        document.getElementById("exercise" + exercise + "ImageInput3"),
                        document.getElementById("exercise" + exercise + "ImageInput4")
                    ],
                    bullets: exerciseBullets[exercise - 1]
                };
            }
            
            function connectToExerciseElements(exerciseElements, images)
            {
                exerciseElements.titleInput.oninput = updateCanvas;
                exerciseElements.titleInput.onchange = updateCanvas;
                exerciseElements.checkBox.oninput = updateCanvas;
                exerciseElements.checkBox.onchange = updateCanvas;
                exerciseElements.borderColor.oninput = updateCanvas;
                exerciseElements.borderColor.onchange = updateCanvas;
                exerciseElements.accentColor.oninput = updateCanvas;
                exerciseElements.accentColor.onchange = updateCanvas;
                exerciseElements.backgroundColor.oninput = updateCanvas;
                exerciseElements.backgroundColor.onchange = updateCanvas;
                for(let i = 0; i < 4; i += 1)
                {
                    exerciseElements.imageInputs[i].onchange = updateImageFunction(images[i]);
                    exerciseElements.imageInputs[i].oninput = updateImageFunction(images[i]);
                    
                    for(let j = 0; j < 4; j += 1)
                    {
                        exerciseElements.bullets[i][j].onchange = updateCanvas;
                        exerciseElements.bullets[i][j].ininput = updateCanvas;
                    }
                }
            }
            
            const exercise1Elements = getExerciseElements(1);
            const exercise2Elements = getExerciseElements(2);
            const exerciseElements = [ exercise1Elements, exercise2Elements ];            
                        
            connectToExerciseElements(exercise1Elements, exercise1Images);
            connectToExerciseElements(exercise2Elements, exercise2Images);
                       
            exercise2CheckBox.onchanged = updateCanvas();
            exercise2CheckBox.oninput = updateCanvas();
                        
            /*****************************************************************/
            function containerSize()
            {
            	const computedStyle = getComputedStyle(container);

                let width = container.clientWidth // width with padding
                let height = container.clientHeight // height with padding

                height -= parseFloat(computedStyle.paddingTop) + parseFloat(computedStyle.paddingBottom)
                width -= parseFloat(computedStyle.paddingLeft) + parseFloat(computedStyle.paddingRight)
                return { "width": width, "height": height };
            }
            
            function resizeCanvas()
            {
            	const size = containerSize();
                const w = size.width;
                const h = size.height;
                const ratio = w / h;
                                
                if (ratio > 0.70710678118)
                {
                    canvas.height = h;
                    canvas.width = h * 0.70710678118;
                }
                else
                {
                    canvas.width = w;
                    canvas.height = w / 0.70710678118;
                }                
            }
            
            function updateCanvas()
            {
                resizeCanvas();
                
                const canvasDrawer = new CanvasDrawer(canvas);
                drawPreview(canvasDrawer, exerciseData(1), exerciseData(2));
            }
            
            /*****************************************************************/
            
            let jsPdfScript = null;
                        
            
            function getBullet(exercise, bullet)
            {
                for(let i = 1; i <= 4; i += 1)
                {
                    const bulletElement = document.getElementById("exercise" + exercise + "Bullet" + bullet + "-" + i);
                    if (bulletElement.checked)
                        return i;
                }
                return 0;
            }
            
            function exerciseData(exercise)
            {
                const elements = exerciseElements[exercise - 1];
                const images = exerciseImages[exercise - 1];
                return { 
                    "title": elements.titleInput.value, 
                    "count": getExerciseCount(),
                    "enabled": elements.checkBox.checked,
                    "images": images,
                    "bullets": [ getBullet(exercise, 1), getBullet(exercise, 2), getBullet(exercise, 3), getBullet(exercise, 4) ],
                    "bulletCount": exerciseBulletCounts[exercise - 1],
                    "borderColor": elements.borderColor.value,
                    "backgroundColor": elements.backgroundColor.value,
                    "accentColor": elements.accentColor.value
                };
            }
            
            function loadJsPdf(callback)
            {
                if (jsPdfScript)
                {
                    callback();
                    return;
                }
                
                jsPdfScript = document.createElement("script");
                jsPdfScript.onload = () => { callback() };
                jsPdfScript.setAttribute('type', 'text/javascript');
                jsPdfScript.setAttribute("src", "js/jspdf.umd.min.js");
                document.body.appendChild(jsPdfScript);
            }
            
            function savePdf()
            {
                loadJsPdf(generatePdf);
            }
            
            function generatePdf()
            {
                const doc = new window.jspdf.jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts:true
                });
                addComicNeue(doc);
                
                const pdfDrawer = new PDFDrawer(doc);
                drawPreview(pdfDrawer, exerciseData(1), exerciseData(2));
                
                saveToPDFButton.enabled = false;
                doc.save(fileTitle.value + ".pdf");
            }
            
            /*****************************************************************/
            
            function toDataUrl(image)
            {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = image.height;
                canvas.width = image.width;
                context.drawImage(image, 0, 0);
                return canvas.toDataURL("image/png");
            }
            
            function createExerciseSaveData(exercise)
            {
                const elements = exerciseElements[exercise - 1];
                const images = exerciseImages[exercise - 1];
                return { 
                    "title": elements.titleInput.value, 
                    "count": getExerciseCount(),
                    "enabled": elements.checkBox.checked,
                    "images": [ toDataUrl(images[0]), toDataUrl(images[1]), toDataUrl(images[2]), toDataUrl(images[3])],
                    "bullets": [ getBullet(exercise, 1), getBullet(exercise, 2), getBullet(exercise, 3), getBullet(exercise, 4) ],
                    "bulletCounts": exerciseBulletCounts[exercise - 1],
                    "borderColor": elements.borderColor.value,
                    "backgroundColor": elements.backgroundColor.value,
                    "accentColor": elements.accentColor.value
                };
            }
            
            function downloadFile(content, fileName) 
            {
                console.log(content);
                const a = document.createElement("a");
                const file = new Blob([content], {type: 'text/plain'});
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }
            
            function createSaveFile()
            {
                return {
                    "version": "1.0.1",
                    "count": getExerciseCount(),
                    "exercises": 
                    [
                        createExerciseSaveData(1),
                        createExerciseSaveData(2)
                    ]
                }
            }
        
            function saveFile()
            {
                downloadFile(JSON.stringify(createSaveFile()), fileTitle.value + '.kdk');                
            }
            
            function loadExercise(exerciseElements, exerciseData, exerciseImages, exercise)
            {
                exerciseBulletCounts[exercise - 1] = exerciseData.bulletCounts || [ 3, 3, 3, 3 ];
                exerciseElements.titleInput.value = exerciseData.title;
                exerciseElements.checkBox.checked = exerciseData.enabled;
                
                for(let i = 0; i < exerciseData.images.length; i += 1)
                {
                    if (exerciseData.images[i] && exerciseData.images[i] !== "data:,")
                        exerciseImages[i].src = exerciseData.images[i];
                }
                
                for(let i = 0; i < exerciseData.bullets.length; i += 1)
                {
                    for(let j = 0; j < 3; j += 1)
                    {
                        exerciseElements.bullets[i][j].checked = (j === (exerciseData.bullets[i] - 1));
                    }
                }
                
                exerciseElements.backgroundColor.value = exerciseData.backgroundColor;
                exerciseElements.accentColor.value = exerciseData.accentColor;
                exerciseElements.borderColor.value = exerciseData.borderColor;
            }
            
            function loadCount(json)
            {
                const count = json.count || 3
                
                if (count === 4)
                {
                    exerciseCountRadio4.checked = true;
                    exerciseCountRadio3.checked = false;
                }
                else
                {
                    exerciseCountRadio4.checked = false;
                    exerciseCountRadio3.checked = true;   
                }
            }
            
            function loadJson(json)
            {
                loadCount(json);                
                loadExercise(exerciseElements[0], json.exercises[0], exerciseImages[0], 1);
                loadExercise(exerciseElements[1], json.exercises[1], exerciseImages[1], 2);
                exerciseCountUpdated();
                updateAllBullets();
                updateAllBulletStates();
                updateCanvas();
            }
            
            function getFileTitle(filename)
            {
                if (filename.endsWith(".kdk"))
                    return filename.substr(0, filename.length - 4);
                return filename;
            }
            
            function loadFile(file)
            {
                if (!file)
                    return;
                const reader = new FileReader();
                reader.onload = function(e) 
                {
                    fileTitle.value = getFileTitle(file.name);
                    const contents = e.target.result;
                    loadJson(JSON.parse(contents));
                };
                reader.readAsText(file);
            }
            
            exerciseCountUpdated();
            updateAllBullets();
            updateAllBulletStates();
            
            (function () {
                "use strict";

                if ('serviceWorker' in navigator) {
                    console.log("registring the service worker...");
                    navigator.serviceWorker.register("sw.js").then(function (registration) {
                        console.log('the service worker has been registered: ', registration);
                    }).catch(function (error) {
                        console.log('the service worker could not be registered', error);
                    });
                }
            }());
		</script>
    </body>
</html>
